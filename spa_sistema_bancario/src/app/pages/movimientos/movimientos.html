<div *ngIf="error()" class="alert alert--error">
  <span class="alert__icon"><i class="material-icons">warning</i></span>
  <span class="alert__message">{{ error() }}</span>
  <button class="alert__close" (click)="clearMessages()"><i class="material-icons">close</i></button>
</div>

<div *ngIf="successMessage()" class="alert alert--success">
  <span class="alert__icon"><i class="material-icons">check_circle</i></span>
  <span class="alert__message">{{ successMessage() }}</span>
  <button class="alert__close" (click)="clearMessages()"><i class="material-icons">close</i></button>
</div>

<section class="card">
  <div class="card__header">
    <div class="card__actions">
      <div class="search-controls">
        <input
          type="text"
          [ngModel]="searchTerm()"
          (ngModelChange)="onSearchChange($event)"
          class="search__input"
          placeholder="Buscar por cuenta, cliente o valor..."
          [disabled]="isLoading()"
        />
        <button 
          *ngIf="searchTerm()" 
          class="search__clear"
          (click)="clearSearch()"
          title="Limpiar búsqueda"
        >
          <i class="material-icons">close</i>
        </button>
      </div>
      <button 
        class="btn btn--primary"
        (click)="openCreateModal()"
        [disabled]="isLoading()"
      >
        <span class="btn__icon"><i class="material-icons">account_balance_wallet</i></span>
        Realizar Movimiento
      </button>
    </div>
  </div>

  <div *ngIf="isLoading()" class="loading">
    <div class="loading__spinner"></div>
    <span>Cargando movimientos...</span>
  </div>

  <div *ngIf="!isLoading()" class="table-container enhanced-table">
    <table class="data-table" *ngIf="filteredMovimientos().length > 0">
      <thead class="data-table__header">
        <tr>
          <th>Fecha</th>
          <th>Cuenta</th>
          <th>Cliente</th>
          <th>Tipo</th>
          <th>Saldo Inicial</th>
          <th>Movimiento</th>
          <th>Saldo Final</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody class="data-table__body">
        <tr *ngFor="let movimiento of filteredMovimientos(); trackBy: trackByMovimientoId">
          <td class="font-semibold">{{ formatDate(movimiento.fecha) }}</td>
          <td>{{ movimiento.numeroCuenta }}</td>
          <td>{{ movimiento.cliente || 'N/A' }}</td>
          <td>
            <span 
              class="badge" 
              [ngClass]="{
                'badge--success': movimiento.movimiento >= 0,
                'badge--warning': movimiento.movimiento < 0
              }">
              {{ getMovimientoType(movimiento.movimiento) }}
            </span>
          </td>
          <td class="text-right font-semibold">{{ movimiento.saldoInicial | currency:'USD':'symbol':'1.2-2' }}</td>
          <td class="text-right font-semibold" 
              [ngClass]="getMovimientoTypeClass(movimiento.movimiento)">
            {{ movimiento.movimiento | currency:'USD':'symbol':'1.2-2' }}
          </td>
          <td class="text-right font-semibold">{{ movimiento.saldoDisponible | currency:'USD':'symbol':'1.2-2' }}</td>
          <td>
            <span 
              class="badge" 
              [ngClass]="getEstadoBadgeClass(movimiento.estado)">
              {{ getEstadoText(movimiento.estado) }}
            </span>
          </td>
          <td>
            <div class="table-actions">
              <button 
                class="action-btn action-btn--delete" 
                title="Eliminar movimiento"
                (click)="openDeleteModal(movimiento)"
                [disabled]="isLoading()"
              >
                <i class="material-icons">delete</i>
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="empty-state" *ngIf="filteredMovimientos().length === 0 && !isLoading()">
      <div class="empty-state__icon"><i class="material-icons">account_balance_wallet</i></div>
      <div class="empty-state__title">
        {{ searchTerm() ? 'No se encontraron movimientos' : 'No hay movimientos registrados' }}
      </div>
      <div class="empty-state__description">
        {{ searchTerm() ? 'Intenta con otros términos de búsqueda' : 'Los movimientos de las cuentas aparecerán aquí' }}
      </div>
      <button 
        *ngIf="!searchTerm()" 
        class="btn btn--primary"
        (click)="openCreateModal()"
      >
        <span class="btn__icon"><i class="material-icons">account_balance_wallet</i></span>
        Realizar Primer Movimiento
      </button>
    </div>
  </div>
</section>

<!-- Modal para realizar movimiento -->
<app-modal
  [isOpen]="isCreateModalOpen()"
  [config]="createModalConfig"
  (close)="closeCreateModal()"
>
  <app-movimiento-form
    #movimientoForm
    (formSubmit)="onCreateMovimiento($event)"
    (formCancel)="closeCreateModal()"
  ></app-movimiento-form>
</app-modal>

<!-- Modal para confirmar eliminación -->
<app-modal
  [isOpen]="isDeleteModalOpen()"
  [config]="deleteModalConfig"
  (close)="closeDeleteModal()"
>
  <div class="delete-confirmation">
    <div class="delete-confirmation__icon"><i class="material-icons">warning</i></div>
    <div class="delete-confirmation__content">
      <p class="delete-confirmation__text">
        ¿Está seguro que desea eliminar este movimiento?
      </p>
      <div class="delete-confirmation__details" *ngIf="selectedMovimiento()">
        <strong>{{ selectedMovimiento()!.numeroCuenta }}</strong><br>
        <span class="text-muted">Cliente: {{ selectedMovimiento()!.cliente || 'N/A' }}</span><br>
        <span [ngClass]="getMovimientoTypeClass(selectedMovimiento()!.movimiento)">
          {{ selectedMovimiento()!.movimiento | currency:'USD':'symbol':'1.2-2' }}
        </span>
      </div>
      <p class="delete-confirmation__warning">
        Esta acción no se puede deshacer.
      </p>
    </div>
  </div>
  <div slot="footer" class="modal__footer-buttons">
    <button 
      class="btn btn--outline" 
      (click)="closeDeleteModal()"
    >
      Cancelar
    </button>
    <button 
      class="btn btn--primary delete-btn" 
      (click)="confirmDelete()"
    >
      Eliminar
    </button>
  </div>
</app-modal>
